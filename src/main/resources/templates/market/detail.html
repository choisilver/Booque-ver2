<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/"
    xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{ layout/layout }">

<div layout:fragment="content">

<head>
    <meta charset="UTF-8">
    <title>Booque Market</title>
    
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

	<style>
		#profile {
			margin-top: 25px;
			margin-bottom: 25px;
			padding-bottom: 25px;
			border-bottom: 1px solid silver;
		}
		
		#content {
			margin-top: 16px;
			margin-bottom: 16px;
		}
		
		#other {
			border-top: 1px solid silver;
			padding-top: 25px;
		}
		
		.otherList {
			margin-bottom: 25px;
			margin-right: 50px;
			display: inline-block;
		}
        
        a {
            text-decoration: none;
            color: black;
        }
        
        a:hover {
            color: black;
        }
		
	</style>
  
</head>
<body>
	
	<div class="w-70 container">
    
    <div class="w-75 container"> <!-- images -->
   
    <div class="w-75 container"> <!-- images -->
        <div id="carouselExampleDark" class="carousel carousel-dark slide">
        
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <div th:each=" imgList : ${ imgList } " class="carousel-inner">
                <div class="carousel-item active">
                    <img th:src="${ '/market/api/view/'+imgList.fileName }" class="d-block w-100" > 
                </div>
                

            </div>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>
   
   
   
   
   
   
            

        
        
        
    </div>
    
    <div id="profile"> <!-- profile -->
    	<a th:href="@{ /market/mypage(id=${ user.id }) }"><!-- 작성자 부끄마켓 개인 페이지로 이동 -->
            <img style="width:80px; height:80px; display:inline-block; margin-right: 10px;" th:src="${ user.userImage }">
        	<div class="align-middle" style="display: inline-block; padding-right: 20px; margin-right: 30px;">
    	    	<div style="font-weight: bold; font-size:23px; display:inline-block" th:text="${ user.nickName + '(' + user.username + ')' }"></div>
                <div class="border rounded-2 bg-success border-success" style="height: 21px; display:inline-block; padding: 1px; text-align: center;">
                    <i class="bi bi-droplet-half" style="font-size: 13px;"></i>
                    <small th:text="${ user.booqueLevel }" ></small>
                    <small th:text="${ user.booqueScore + 'P' }"></small>
                </div>
                <div th:text="${ usedBook.location }"></div>
                <input type="hidden" id="usedLocation" th:value="${ usedBook.location }"/>
                <div class="align-middle" style="color:gray;">
                    <i class="bi bi-heart-fill" style="font-size:12px;"></i> 관심 <span id="wishCount" th:text="${ usedBook.wishCount }"></span> 
                    <i class="bi bi-person-circle" style="font-size:14px; margin-left:8px;"></i> 채팅 <span  th:text="${ usedBook.chats }"></span>
                    <i class="bi bi-eye" style="font-size:17px; margin-left:8px;"></i> 조회 <span th:text="${ usedBook.hits }"></span>
                </div>
        	</div>
        </a>
        
    	<div class="align-middle float-end" style="display: inline-block;" th:if="${ user.username } != ${ #authentication.name }">
	    	 <!-- 채팅하기 -->
             <!-- 새 창으로 뜨도록(채팅하는 동시에 부끄 사이트에서 다른 동작 수행 가능 -->
            <button th:data-url="@{ /chat(withChatUsername=${user.username}) }" onclick="openWindow(this.getAttribute('data-url'))" 
            type="button" class=" btn btn-primary" style="width:120px; height:40px;">채 팅 하 기</button>
    	</div>
        
        <div class="align-middle float-end" style="display: inline-block;" th:unless="${ user.username } != ${ #authentication.name }">
            <a class="btn btn-success" th:href="@{ /market/modify?usedBookId={usedBookId} (usedBookId = ${ usedBook.id })}" style="width:120px; height:40px; margin-left: 20px;">수 정 하 기</a>
        </div>
    	<div class="align-middle float-end" style="display: inline-block;" >
            <div id="btnUsedBookWish">
                <div th:if="${ wish==null  } ">
                    <img id="noWish" style="width: 25px; " src=" https://cdn-icons-png.flaticon.com/512/833/833300.png" /> 
                </div>
                <div th:if="${ wish!=null  } ">
                    <img id="yesWish" style="width: 25px; " alt="취소" src="https://cdn-icons-png.flaticon.com/512/833/833472.png" />
                
                </div>
                
                    <img id="yesWish" style="width: 25px; display:none; " src="https://cdn-icons-png.flaticon.com/512/833/833472.png" />
                    <img id="noWish" style="width: 25px; display:none;" src=" https://cdn-icons-png.flaticon.com/512/833/833300.png" /> 
                    <input id="usedBookId" name="usedBookId" type="hidden" th:value="${ usedBook.id }" />
            </div>
    	</div>
    </div>
    
    <div> <!-- content -->        
        <div class="w-75 align-top" style="display: inline-block;"> <!-- content left -->
            <div th:if="${ user.username } == ${ #authentication.name }">
                <select onchange="changeStatus()" id="selectStatus" name="selectStatus" class="form-select" style="width:120px; height: 40px; margin-bottom: 10px; display: inline-block;">
                    <option value="판매중" th:selected="${ usedBook.status } == '판매중'">판매중</option>
                    <option value="예약중" th:selected="${ usedBook.status } == '예약중'">예약중</option>
                    <option value="판매완료" th:selected="${ usedBook.status } == '판매완료'">판매완료</option>
                </select>
            </div>
            <div th:unless="${ user.username } == ${ #authentication.name }">
                <select class="form-select" style="width:120px; height: 40px; margin-bottom: 10px;" disabled>
                    <option th:text="${ usedBook.status }" th:value="${ usedBook.status }"></option>
                </select>
            </div>
            
    	    <div class="h3" th:text="${ usedBook.title }"></div>
    	    <div class="h2" style="color: red;" th:text="|${#numbers.formatInteger(usedBook.price, 0, 'COMMA')}원|"></div>	
            <div th:text="${ #numbers.formatDecimal(sale, 2, 0) + '% 할인' }"></div>
            <div>상품상태: <span th:text="${ usedBook.bookLevel }"></span></div>
    	    <small style="color: gray;" th:text="${ #temporals.format(usedBook.modifiedTime, 'yyyy/MM/dd HH:mm') }"></small>
    	    <div id="content" th:text="${ usedBookPost.content }" style="white-space:pre; font-size:18px; margin-bottom:100px;"></div>
            <div id="map" style="width:300px; height:300px; margin-top:10px; margin-bottom:10px; z-index:-1"></div>
            <span>거래장소: </span>
            <input type="text" id="usedLocation" th:value="${ usedBook.location }" style="width: 300px; border: none; margin-bottom:10px;" />
        </div> <!-- content left end -->
        
        <div class="float-end" style="display: inline-block;"> <!-- content right -->
        <a th:href="@{ /detail(id=${ book.bookId }) }">
            <div class="card mx-2 my-2" style="width: 20rem;">    
                <img th:src="${ book.bookImage }"  class="card-img-top" alt="..." />
                <div class="card-body" style="text-align: left;">
                    <div class="my-2">
                        <small class="d-inline-flex px-2 border border-1 rounded text-secondary">
                            <span th:text="${ book.bookgroup }"></span><span> / </span><span th:text="${ book.category }"></span>
                        </small>
                    </div>
                    <div class="card-title" style="font-weight: bold; font-size: 15px;" th:text="${ book.bookName }"></div>
                    <div th:text="${ book.author }"></div>
                    <div>
                        <span th:text="|${#numbers.formatInteger(book.prices, 0, 'COMMA')}원|"></span>(정가)
                    </div>
                </div>
            </div>
        </a>
        </div> <!-- content right end -->
    </div> <!-- content end -->
    
    <div id="other"> <!-- 이 책의 다른 중고 상품은? -->
    	<h4><span>이 책</span>의 다른 중고 상품은?</h4>
    	<div class="otherList align-middle" th:each="usedBook : ${ otherUsedBookListFinal }"> <!-- 다른 상품 나열 부분 -->
    		<div style="width:200px; height: 315px;"> <!-- 상품목록 1개 -->
    		<a th:href="@{ /market/detail(usedBookId=${ usedBook.id }) }">
    			<div class="border" style="width:200px; height: 200px; margin-bottom: 5px;"></div>
    			<div class="text-truncate" th:text="${ usedBook.title }" style="font-size:17px;"></div>
    			<div th:text="|${#numbers.formatInteger(usedBook.price, 0, 'COMMA')}원|" style="font-weight: bold;"></div>
    			<span th:text="${ usedBook.bookLevel }" style="color:red; font-weight:bold;"></span>
                <small th:text="${ usedBook.location }" style="display: block;"></small>
                <div class="align-middle" style="color:gray;">
                    <small>
                    <i class="bi bi-heart-fill" style="font-size:10px;"></i> 관심 <span id="wishCount" th:text="${ usedBook.wishCount }"></span> 
                    <i class="bi bi-person-circle" style="font-size:12px; margin-left:8px;"></i> 채팅 <span  th:text="${ usedBook.chats }"></span>
                    <i class="bi bi-eye" style="font-size:13px; margin-left:8px;"></i> 조회 <span th:text="${ usedBook.hits }"></span>
                </small>
                </div>
    		</a>
    		</div>
    	</div>
    </div>
    
	</div> <!-- w-70 end -->
	
    <!-- 부트스트랩 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script th:src="@{ /js/usedBookwish.js }"></script>
    <!-- 자바스크립트 부분 -->
    <script type="text/javascript">
    // (하은) 책 판매여부 변경

    
    function changeStatus() {
        
        const status = document.querySelector('#selectStatus').value;
        const usedBookId = document.querySelector('#usedBookId').value;

        const statusDto = {
            status : status,
            usedBookId : usedBookId
        }
        axios.post('/market/changeStatus', statusDto)
             .then(response =>{
            	 alert(status + '(으)로 변경되었습니다!');
                 console.log(response)
             })
        
    }
    
    
    
    
    </script>
    
    <!--(하은) 지도 api -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=19b2b9b68708139f3460b2a5ab366793&libraries=services"></script>
    <script>
        var container = document.getElementById('map'); // 지도를 표시할 div
        var option = {
        	center: new daum.maps.LatLng(37.537187, 127.005476), // 지도의 중심좌표
            level: 5 // 지도의 확대 레벨
        }
        
        //지도를 미리 생성
        var map = new daum.maps.Map(container, option);
        
        //주소-좌표 변환 객체를 생성
        var geocoder = new daum.maps.services.Geocoder();
        
        const usedLocation = document.querySelector('#usedLocation').value;
        
        console.log(usedLocation);
        
        geocoder.addressSearch(usedLocation, function(result, status) {
        	// 정상적으로 검색 됐을 시
        	 if (status === daum.maps.services.Status.OK) {
    
                 // 해당 주소에 대한 좌표를 받아서
                 var coords = new daum.maps.LatLng(result[0].y, result[0].x);
                 
                 // 결과값으로 받은 위치를 마커로 표시합니다
                 var marker = new daum.maps.Marker({
                     map: map,
                     position: coords
                 });
                 
                 // 지도 중심을 변경한다.
                 map.setCenter(coords);
             }
        });
    </script>
    
</body>
</div>
</html>